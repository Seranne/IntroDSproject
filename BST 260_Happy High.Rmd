---
title: "BST 260_Happy Highs"
sub_title: "Exploring the Realm of Happiness and Well-being"
author: "Seranne Motital, Shravanthi Seshasayee, Sanjana Sunderesan"
date: "9 December 2017"
output: html_document
---

```{r echo=FALSE}
library(dplyr)
library(tidyverse)
library(knitr)
library(readr)
library(tidyverse)
library(readr)
library(ggplot2)
```

# Overview and Motivation
The World Happiness Report is a composite measure of country-level happiness based on economic and social factors such as per capita GDP, social support, healthy life expectancy at birth, freedom to make life choices, generosity and perceptions of corruption, released annually by the UN Sustainble Development Solutions Network. In the present landscape of shifting political and economic climates across the world, we believe it is important to expand and include measures which encompass a wider narrative of the human experience. We are keen to understand the association between country-level physical, financial, social, cultural, political, and environmental indicators and the parent country's ranking on an overall well-being index. For instance, tt would be interesting to learn more about the influences of variables such as Gini Coefficients, literacy levels, deforestation, climate etc. on the happiness ranking of a country. 

We hope to understand the underlying variables most responsible for these scores, and identify conceptual and measurement gaps in the development of an overall score of country-level well-being. We believe that factors such as racial diversity, environmental sustainability, and population skew, among others, are either missing or underrepresented in the present composite measure. We aim to modify this to build a more well-rounded measure of the well-being of a country.  
We believe that this information could potentially inform policies to improve overall country happiness and human flourishing.  

# Related Work:  Anything that inspired you, such as a paper, a web site, or something we discussed in class.

# Initial Questions: What questions are you trying to answer? How did these questions evolve over the course of the project? What new questions did you consider in the course of your analysis?

We began our project with the goal of identifying yearly-changes in a country's happiness and well-being. However, as we learnt more about how these composite indices are derived, we grew keen to understand the factors considered in the creation of a well-being score. Over the course of our literature review, we identified more variables we believe are relevant to a population's well-being, and decided to create a new, incremented ranking of country well-being with this additional data. Thus, our project seeks to answer: 

- Is there a change in the average ranking of a country's happiness and well-being, given the inclusion of a more comprehensive variable list representing its physical, social, cultural, economic and political enviroments?
- Are are specific variables which contribute more to this derived composite index, than others?


# Data: Source, scraping method, cleanup, etc.

In order to develop our well-being index, we extracted data from a number of resources, categorized below: (To make a table displaying our variables with categories). 
```{r}
org = c("World Bank", "United Nations Sustainable Development Solutions Network", "New Economics Foundation", "Wikipedia (Fearon's Analysis)")
dat <- c("World Development Indicators (2010-17)", "World Happiness Report", "Happy Planet Index", "Ethnic Fractionalization Index")

datasources <- data.frame("Source" = org, "Data" = dat)

categs <- c("Population Charateristics", "Child Welfare", "Gender", "Employment","Economic Indicators", "Energy Indicators", "Emissions", "Connectivity", "Environmental Welfare", "Food Deficit", "Sense of Security", "Travel for Leisure")

print(kable(datasources))
print(kable(categs))

#dsources <- c("World Bank: World Development Indicators", "Happy Planet Index", "Wikipedia", "UN SDSN: World Happiness Report")
#dframe1 %>% data.frame("Indicators" = categs) %>% kable
```

From each of our sources, we selected variables most relevant to the creation of our composite index (based on literature review). A Pearson's correlation was run across all chosen variables [REF in the Google Doc], to identify variables with high correlation, and assign these correlated variables with lower weights in our final composite score, to avoid double counting of similar variables. 

A country-wise ranking was then generated for each variable, in every category. Every country then received a category-wise composite score, calculated as 


# Exploratory Analysis: What visualizations did you use to look at your data in different ways? What are the different statistical methods you considered? Justify the decisions you made, and show any major changes to your ideas. How did you reach these conclusions?

- Scatterplot of the WHR countries ranks?
- Association between maybe ethnic fractionalization/total population/environmental biodiversity and these ranks? [T perhaps justify why we don't think that these ranks are very accurate]

```{r}

```

## Methods: 

# Extracting data from the World Bank World Development Indicators

The World Bank's World Development Indicators were downloaded from [Kaggle](https://www.kaggle.com/worldbank/world-development-indicators), and this dataset is available for download as a .csv from [this link](https://drive.google.com/open?id=1ilfW3OIrVs6b4EsFPFbW-dw_vQiQgetU). However, given the large size of this data, our initial stage dataset is available as a smaller-sized url-linked csv (in the following code chunk), on which the rest of the code was run.

```{r, eval=FALSE}
# Replace path name with that of the downloaded csv file
Indicators_csv <- read_csv("Download/Path/Here.csv")

# Filter by Year
WDI <- filter(Indicators_csv, Year == "2010"| Year == "2011" | Year == "2012"| Year == "2013" | Year == "2014" | Year == "2015" | Year == "2016" | Year =="2017")

# Remove Aggregated Country classifications, by country code
WDInew <- filter(WDI, CountryCode != "WBG")
WDInew <- filter(WDInew, CountryCode != "WLD")
WDInew <- filter(WDInew, CountryCode != "UMC")
WDInew <- filter(WDInew, CountryCode != "SST")
WDInew <- filter(WDInew, CountryCode != "SSF")
WDInew <- filter(WDInew, CountryCode != "SSA")
WDInew <- filter(WDInew, CountryCode != "SAS")
WDInew <- filter(WDInew, CountryCode != "OSS")
WDInew <- filter(WDInew, CountryCode != "OED")
WDInew <- filter(WDInew, CountryCode != "MNA")
WDInew <- filter(WDInew, CountryCode != "MEA")
WDInew <- filter(WDInew, CountryCode != "LMC")
WDInew <- filter(WDInew, CountryCode != "LIC")
WDInew <- filter(WDInew, CountryCode != "LMY")
WDInew <- filter(WDInew, CountryCode != "LDC")
WDInew <- filter(WDInew, CountryCode != "LAC")
WDInew <- filter(WDInew, CountryCode != "LCN")
WDInew <- filter(WDInew, CountryCode != "OEC")
WDInew <- filter(WDInew, CountryCode != "NOC")
WDInew <- filter(WDInew, CountryCode != "NAC")
WDInew <- filter(WDInew, CountryCode != "MIC")
WDInew <- filter(WDInew, CountryCode != "HIC")
WDInew <- filter(WDInew, CountryCode != "HPC")
WDInew <- filter(WDInew, CountryCode != "FCS")
WDInew <- filter(WDInew, CountryCode != "EUU")
WDInew <- filter(WDInew, CountryCode != "ECA")
WDInew <- filter(WDInew, CountryCode != "ECS")
WDInew <- filter(WDInew, CountryCode != "EMU")
WDInew <- filter(WDInew, CountryCode != "EAP")
WDInew <- filter(WDInew, CountryCode != "EAS")
WDInew <- filter(WDInew, CountryCode != "CEB")
WDInew <- filter(WDInew, CountryCode != "ARB")

# Filter dataset to only include variables of interest 
WDI2 <- filter(WDInew, IndicatorCode == "AG.LND.FRST.ZS" | IndicatorCode == "EG.FEC.RNEW.ZS"|IndicatorCode == "EG.USE.COMM.FO.ZS"|IndicatorCode == "EG.ELC.ACCS.ZS"|IndicatorCode == "EG.USE.ELEC.KH.PC"| IndicatorCode == "EN.ATM.CO2E.PC"|IndicatorCode == "ER.PTD.TOTL.ZS"| IndicatorCode == "EN.POP.DNST"|IndicatorCode == "ER.PTD.TOTL.ZS"|IndicatorCode == "FP.CPI.TOTL.ZG"|IndicatorCode == "GC.XPN.COMP.ZS"|IndicatorCode == "IC.FRM.CRIM.ZS"|IndicatorCode == "IC.FRM.FEMM.ZS"|IndicatorCode == "IC.LGL.CRED.XQ"|IndicatorCode == "IT.CEL.SETS.P2"|IndicatorCode == "IT.NET.USER.P2"|IndicatorCode == "MS.MIL.XPND.GD.ZS"|IndicatorCode == "NY.GDP.PCAP.CD"|IndicatorCode == "NY.GDP.MKTP.PP.CD"|IndicatorCode == "NY.GDP.PCAP.KD.ZG"|IndicatorCode == "SE.ADT.1524.LT.ZS"|IndicatorCode == "SE.ADT.LITR.ZS"|IndicatorCode == "SG.GEN.PARL.ZS"|IndicatorCode == "SG.VAW.REAS.ZS"|IndicatorCode == "SH.DTH.MORT"|IndicatorCode == "SI.POV.GINI"|IndicatorCode == "SL.EMP.WORK.ZS"|IndicatorCode == "SL.FAM.0714.ZS"|IndicatorCode == "SP.DYN.IMRT.IN"|IndicatorCode == "SL.UEM.NEET.ZS"|IndicatorCode == "SM.POP.TOTL.ZS"|IndicatorCode == "SN.ITK.DFCT"|IndicatorCode == "SP.DYN.LE00.IN"|IndicatorCode == "SP.UWT.TFRT"|IndicatorCode == "ST.INT.DPRT"|IndicatorCode == "SP.POP.TOTL"|IndicatorCode == "VC.IHR.PSRC.P5")

write.csv(WDI2, file = "ourWDI.csv")
```

If the above original dataset was not downloaded, the code below runs on the .csv generated at the end of the above code chunk 

```{r}
# Load dataset
url <- "https://raw.githubusercontent.com/Seranne/IntroDSproject/master/ourWDI.csv"
WDI4 <- read.csv(url)
WDI4<- select(WDI4,"CountryName","CountryCode", "IndicatorCode", "Year","Value")

# Change Country Names to standard names
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "Micronesia, Fed. Sts."] <- "Micronesia"
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "United States"] <- "United States of America"
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "Congo, Rep."] <- "Republic of Congo"
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "Russian Federation"] <- "Russia"
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "Congo, Dem. Rep."] <- "Democratic Republic of Congo"
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "Eygpt, Arab Rep."] <- "Egypt"
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "Iran, Islamic Rep."] <- "Iran"
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "Korea, Dem. Rep"] <- "North Korea"
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "Korea, Rep."] <- "South Korea"
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "Kyrgyz Republic"] <- "Kyrgyzstan"
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "Slovak Republic"] <- "Slovakia"
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "Syrian Arab Republic"] <- "Syria"
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "China & Hong Kong SAR, China"] <- "Hong Kong"
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "Macedonia, FYR"] <- "Macedonia"
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "Bahamas, The"] <- "Bahamas"
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "Gambia, The"] <- "Gambia"
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "Venezuela, RB"] <- "Venezuela"
levels(WDI4$CountryName)[levels(WDI4$CountryName) == "Yemen, Rep."] <- "Yemen"
```


# Generating Category scores for each country

Composite Energy Score: 

```{r}
# Selecting indicators of interest 
energy <- WDI4%>% filter(IndicatorCode == "EG.FEC.RNEW.ZS"|IndicatorCode == "EG.USE.COMM.FO.ZS"|IndicatorCode == "EG.ELC.ACCS.ZS"|IndicatorCode == "EG.USE.ELEC.KH.PC") %>% spread(IndicatorCode, Value)

# Access to Electricity (% of population); Highest score gets ranked 1
 energy1<- select(energy, "CountryName", "CountryCode", "Year", "EG.ELC.ACCS.ZS")
 energy1 <- energy1[order(-energy1$Year),]
 energy1<- na.omit(energy1)
 energy1 <- energy1%>% distinct(CountryName, .keep_all = TRUE)
 energy1 <- energy1 %>% mutate(finalrank_eng1 = rank(-energy1$EG.ELC.ACCS.ZS))
 energy1$finalrank_eng1<- as.numeric(as.factor(energy1$finalrank_eng1))
 
 # Renewable Energy Consumption (% of final energy consumption); Highest score gets ranked 1
 energy2<- select(energy, "CountryName", "CountryCode", "Year", "EG.FEC.RNEW.ZS")
 energy2 <- energy2[order(-energy2$Year),]
 energy2<- na.omit(energy2)
 energy2 <- energy2%>% distinct(CountryName, .keep_all = TRUE)
 energy2 <- energy2 %>% mutate(finalrank_eng2 = rank(energy2$EG.FEC.RNEW.ZS))
 energy2$finalrank_eng2<- as.numeric(as.factor(energy2$finalrank_eng2))
 
 # Fossil fuel energy consumption (% of total);lowest consumption ranked 1
 energy3<- select(energy, "CountryName", "CountryCode", "Year", "EG.USE.COMM.FO.ZS")
 energy3 <- energy3[order(-energy3$Year),]
 energy3<- na.omit(energy3)
 energy3 <- energy3%>% distinct(CountryName, .keep_all = TRUE)
 energy3 <- energy3 %>% mutate(finalrank_eng3 = rank(energy3$EG.USE.COMM.FO.ZS))
 energy3$finalrank_eng3<- as.numeric(as.factor(energy3$finalrank_eng3))
 
 #Electric Power consumption (kW/capita); highest score gets ranked 1 
 energy4<- select(energy, "CountryName", "CountryCode", "Year", "EG.USE.ELEC.KH.PC")
 energy4 <- energy4[order(-energy4$Year),]
 energy4<- na.omit(energy4)
 energy4 <- energy4%>% distinct(CountryName, .keep_all = TRUE)
 energy4 <- energy4 %>% mutate(finalrank_eng4 = rank(-energy4$EG.USE.ELEC.KH.PC))
 energy4$finalrank_eng4<- as.numeric(as.factor(energy4$finalrank_eng4))
 
 Enjoin <- left_join(energy1, energy2, "CountryName")
 Ener<- left_join(Enjoin, energy3, "CountryName")
 energy<- left_join(Ener, energy4, "CountryName")
 energy<- select(energy,"CountryName", "finalrank_eng1", "finalrank_eng2", "finalrank_eng3", "finalrank_eng4")
 
 energy <- energy[rowSums(is.na(energy)) < 3, ]
 i <- which(is.na(energy), arr.ind = TRUE)
 energy[i] <- rowMeans(energy[,-1], na.rm = TRUE)[i[,1]]
 
# Highest aggregate score is ranked 1
energy_score <- energy %>% mutate(score_eng = (finalrank_eng1 + finalrank_eng2 + finalrank_eng3 + finalrank_eng4)/4)
energy <- energy %>% mutate(finalrank_eng = rank(-energy$score_eng))
```

CO2 Emissions score:

```{r}
# Select indicator variable: CO2 emissions (metric tons per capita)
emissions <- WDI4%>% filter(IndicatorCode == "EN.ATM.CO2E.PC")%>% spread(IndicatorCode, Value)

# Lowest score gets ranked 1
emissions_score <- emissions %>% 
  group_by(CountryName) %>% 
  summarise(mean_CO2 = mean(EN.ATM.CO2E.PC)) %>%
  na.omit() %>%
  mutate(finalrank_emission = rank(mean_CO2))
```

Composite Environmental well-being score: 

```{r}
# Selecting indicator variables: Terrestrial and marine protected areas (% of total territorial area) and Forest area (% of land area)

envir <- WDI4 %>% filter(IndicatorCode == "ER.PTD.TOTL.ZS"|IndicatorCode == "AG.LND.FRST.ZS") %>% spread(IndicatorCode, Value)

# Highest score gets ranked 1
environment_score <- envir %>% 
  group_by(CountryName) %>% 
  na.omit() %>%
  summarise(mean_agland = mean(AG.LND.FRST.ZS), mean_protect = mean(ER.PTD.TOTL.ZS)) %>%
  mutate(rank_agland = rank(mean_agland), rank_protect = rank(mean_protect)) %>%
  mutate(score = (rank_agland+rank_protect)/2) %>%
  mutate(finalrank_env = rank(-score)) %>%
  select(CountryName, finalrank_env)
```

Communication/Connectivity score: 

```{r}
# Score based on Mobile cellular subscriptions (per 100 people) and Internet Users (per 100 people)
# Highest score gets ranked 1 

comm <- WDI4 %>% filter(IndicatorCode == "IT.CEL.SETS.P2"|IndicatorCode == "IT.NET.USER.P2")  %>% spread(IndicatorCode, Value)
comm <- na.omit(comm)
comm <- comm[order(-comm$Year),]
comm <- comm %>% distinct(CountryName, .keep_all = TRUE)
comm <- comm %>% mutate(rankcell = rank(IT.CEL.SETS.P2)) 
comm <- comm %>% mutate(ranknet = rank(IT.NET.USER.P2))
comm <- comm %>% mutate(score = (rankcell+ranknet)/2)
comm <- comm %>% mutate(finalrank_comm = rank(-comm$score))
communications_score <- select(comm, "CountryName", "CountryCode","finalrank_comm" )
```

Composite Child Welfare score:

```{r}
children<- WDI4 %>% filter(IndicatorCode == "SL.FAM.0714.ZS"|IndicatorCode == "SL.UEM.NEET.ZS" | IndicatorCode == "SP.DYN.IMRT.IN") %>% spread(IndicatorCode, Value)

# Share of children not in education, employment or training: lowest score gets ranked 1 
neet <- select(children, "CountryName", "Year", "SL.UEM.NEET.ZS")
neet <- neet[order(-neet$Year),]
neet <- na.omit(neet)
neet <- neet %>% distinct(CountryName, .keep_all = TRUE)

# Infant mortality rate: lowest score gets ranked 1
imr <- select(children, "CountryName", "Year", "SP.DYN.IMRT.IN")
imr <- imr[order(-imr$Year),]
imr <- na.omit(imr)
imr <- imr %>% distinct(CountryName, .keep_all = TRUE)
imr <- mutate(imr, rank.imr = as.numeric(as.factor(rank((SP.DYN.IMRT.IN)))))

# Lowest aggregrate score gets ranked 1, indicating best child welfare score 

childwelfare <- left_join(imr, neet, by = "CountryName")
childwelfare <- select(childwelfare, "CountryName", "SL.UEM.NEET.ZS", "SP.DYN.IMRT.IN", "rank.imr")

# Filling missing values in NEET using average of othercountry NEET scores 
avgneet <- mean(neet$SL.UEM.NEET.ZS)
childwelfare$SL.UEM.NEET.ZS[is.na(childwelfare$SL.UEM.NEET.ZS)] <- avgneet
childwelfare <- mutate(childwelfare, rank.neet = as.numeric(as.factor(rank((SL.UEM.NEET.ZS)))))
childwelfare_score <- mutate(childwelfare, finalscore_child = as.numeric
                       (as.factor(rank(((rank.neet+rank.imr)/2)))))
```

Food Deficit score:

```{r}
# Load dataset and select indicator: Depth of the food deficit (kilocalories per person per day)
deficit <- WDI4 %>% filter(IndicatorCode == "SN.ITK.DFCT") %>% spread(IndicatorCode, Value)

# Country with the least food deficit will rank 1
deficit <- select(deficit, "CountryName", "Year", "SN.ITK.DFCT")
deficit <- deficit[order(-deficit$Year),]
deficit <- deficit %>% distinct(CountryName, .keep_all = TRUE)
View(deficit)

deficit.score = as.numeric(as.factor(rank((deficit$SN.ITK.DFCT))))
deficit_score <- deficit %>% mutate(finalrank_deficit = 
                                as.numeric(as.factor(rank((deficit$SN.ITK.DFCT)))))
```

Economic score: 

```{r}
# Selecting relevant economic indicators
GDP_base <- WDI4 %>% filter(IndicatorCode == "MS.MIL.XPND.GD.ZS"|IndicatorCode == "NY.GDP.PCAP.CD"|IndicatorCode == "NY.GDP.MKTP.PP.CD"|IndicatorCode == "NY.GDP.PCAP.KD.ZG"|IndicatorCode == "FP.CPI.TOTL.ZG") %>% spread(IndicatorCode, Value)

#Individual data frames for each variable of GDP

#Military expenditure (% of GDP) - Lowest expenditure will be ranked 1
gdp_1 <- GDP_base %>% 
  select(CountryName, Year, MS.MIL.XPND.GD.ZS) %>%
  na.omit() %>%
  group_by(CountryName) %>% 
  summarise(mean_mil = mean(MS.MIL.XPND.GD.ZS)) %>%
  mutate(finalrank_mil = rank(mean_mil))

#GDP per capita (in USD) - Country with the highest GDP will be ranked 1
gdp_2 <- GDP_base %>% 
  select(CountryName, Year, NY.GDP.MKTP.PP.CD) %>%
  na.omit() %>%
  group_by(CountryName) %>% 
  summarise(mean_ppp = mean(NY.GDP.MKTP.PP.CD)) %>%
  mutate(finalrank_ppp = rank(-mean_ppp))

#GDP per capita, PPP (in current international dollar) - Country with the highest GDP will be ranked 1
gdp_3 <- GDP_base %>% 
  select(CountryName, Year, NY.GDP.PCAP.CD) %>%
  na.omit() %>%
  group_by(CountryName) %>% 
  summarise(mean_gdp = mean(NY.GDP.PCAP.CD)) %>%
  mutate(finalrank_gdp = rank(-mean_gdp))

#GDP per capita growth (annual %) - Country with highest GDP will be ranked 1
gdp_4 <- GDP_base %>% 
  select(CountryName, Year, NY.GDP.PCAP.KD.ZG) %>%
  na.omit() %>%
  group_by(CountryName) %>% 
  summarise(mean_gdpg = mean(NY.GDP.PCAP.KD.ZG)) %>%
  mutate(finalrank_gdpg = rank(-mean_gdpg))

#Inflation (annula %) - Country with the lowest annual inflation % will rank 1
gdp_5 <- GDP_base %>% 
  select(CountryName, Year, FP.CPI.TOTL.ZG) %>%
  na.omit() %>%
  group_by(CountryName) %>% 
  summarise(mean_infl = mean(FP.CPI.TOTL.ZG)) %>%
  mutate(finalrank_infl = rank(mean_infl))

#Joining the ranks from all of the variables
GDP_a <- left_join(gdp_1, gdp_2, "CountryName")
GDPjoin <- left_join(GDP_a, gdp_3, "CountryName")
GDPjoin <- left_join(GDPjoin, gdp_4, "CountryName")
GDPjoin <- left_join (GDPjoin, gdp_5, "CountryName")
GDP2 <- GDPjoin %>% select(CountryName, finalrank_mil, finalrank_ppp, finalrank_gdp, finalrank_gdpg, finalrank_infl)

GDP2 <- GDP2[rowSums(is.na(GDP2)) < 4, ]
i <- which(is.na(GDP2), arr.ind = TRUE)
GDP2[i] <- rowMeans(GDP2[,-1], na.rm = TRUE)[i[,1]]

# Country with the highest average score will rank 1
GDP2 <- GDP2 %>% mutate(score_gdp = (finalrank_mil + finalrank_ppp+ finalrank_gdp + finalrank_gdpg + finalrank_infl)/5)
economy_score <- GDP2 %>% mutate(finalrank_GDP = rank(GDP2$score_gdp))
```

Education score:

```{r}
# Selecting relevant indicator variables: Youth literacy rate, population 15-24 years, both sexes (%) and Adult literacy rate, population 15+ years, both sexes (%) 

Education <- WDI4 %>% filter(IndicatorCode == "SE.ADT.1524.LT.ZS"|IndicatorCode == "SE.ADT.LITR.ZS") %>% spread(IndicatorCode, Value)

# Highest rate of youth literacy will be ranked 1
En1<- select(Education, "CountryName", "CountryCode", "Year", "SE.ADT.1524.LT.ZS")
En1 <- En1[order(-En1$Year),]
En1<- na.omit(En1)
En1 <- En1%>% distinct(CountryName, .keep_all = TRUE)
En1 <- En1 %>% mutate(rank_eng1 = rank(-En1$SE.ADT.1524.LT.ZS))
En1$rank_eng1<- as.numeric(as.factor(En1$rank_eng1))

# Highest rate of adult literacy will be ranked 1
En2<- select(Education, "CountryName", "CountryCode", "Year", "SE.ADT.LITR.ZS")
En2 <- En2[order(-En2$Year),]
En2<- na.omit(En2)
En2 <- En2%>% distinct(CountryName, .keep_all = TRUE)
En2 <- En2 %>% mutate(rank_eng2 = rank(-En2$SE.ADT.LITR.ZS))
En2$rank_eng2<- as.numeric(as.factor(En2$rank_eng2))

# Country with the highest average literacy rte will be ranked 1
litjoin <- left_join(En1, En2, "CountryName")
Education <- select(litjoin,"CountryName", "rank_eng1", "rank_eng2")
Education <- Education%>% mutate(score_edu = (rank_eng1 + rank_eng2)/2)
education_score <- Education %>% mutate(finalrank_edu = rank(Education$score_edu))
```

Gender score:

```{r}
# Select indicator variable to assess gender equity: Proportion of seats held by women in national partliaments (%)

gender <- WDI4 %>% filter(IndicatorCode == "SG.GEN.PARL.ZS") %>% spread(IndicatorCode, Value)

gender <- select(gender, "CountryName", "CountryCode", "Year", "SG.GEN.PARL.ZS")
gender <- gender[order(-gender$Year),]
gender <- na.omit(gender)
gender <- gender%>% distinct(CountryName, .keep_all = TRUE)
gender_score <- gender %>% mutate(finalrank_gen = rank(-gender$SG.GEN.PARL.ZS))
gender_score$finalrank_gen<- as.numeric(as.factor(gender_score$finalrank_gen))
```

Employment score:

```{r}
# Select indicator variable: Wage and salaried workers, total (% of total employed)
# country with the highest % of wage and salaried workers will be ranked 1

empl<- WDI4 %>% filter(IndicatorCode == "SL.EMP.WORK.ZS") %>% spread(IndicatorCode, Value)
empl <- select(empl, "CountryName", "Year", "SL.EMP.WORK.ZS")
empl <- empl[order(-empl$Year),]
empl <- empl %>% distinct(CountryName, .keep_all = TRUE)

employment_score <- empl %>% mutate(finalrank_empl =
                          as.numeric(as.factor(rank(-(empl$SL.EMP.WORK.ZS)))))
```

Population score:

```{r}
# Select relevant indicator variables

Population <- WDI4 %>% filter(IndicatorCode == "SI.POV.GINI"|IndicatorCode == "SM.POP.TOTL.ZS"|IndicatorCode == "SP.DYN.LE00.IN" | IndicatorCode == "SP.POP.TOTL"| IndicatorCode == "EN.POP.DNST") %>% spread(IndicatorCode, Value)

# Population density (people per sq. km of land area): Lowest ranked 1
 Population1<- select(Population, "CountryName", "CountryCode", "Year", "EN.POP.DNST")
 Population1 <- Population1[order(-Population1$Year),]
 Population1<- na.omit(Population1)
 Population1 <- Population1%>% distinct(CountryName, .keep_all = TRUE)
 Population1 <- Population1 %>% mutate(finalrank_pop1 = rank(Population1$EN.POP.DNST))
 Population1$finalrank_pop1<- as.numeric(as.factor(Population1$finalrank_pop1))
 
 # GINI index: Lowest ranked 1
 Population2<- select(Population, "CountryName", "CountryCode", "Year", "SI.POV.GINI")
 Population2 <- Population2[order(-Population2$Year),]
 Population2<- na.omit(Population2)
 Population2 <- Population2%>% distinct(CountryName, .keep_all = TRUE)
 Population2 <- Population2 %>% mutate(finalrank_pop2 = rank(Population2$SI.POV.GINI))
 Population2$finalrank_pop2<- as.numeric(as.factor(Population2$finalrank_pop2))
 
 
# Life expectancy at birth (total, in years): Highest ranked 1
 Population3<- select(Population, "CountryName", "CountryCode", "Year", "SP.DYN.LE00.IN")
 Population3 <- Population3[order(-Population3$Year),]
 Population3<- na.omit(Population3)
 Population3 <- Population3%>% distinct(CountryName, .keep_all = TRUE)
 Population3 <- Population3 %>% mutate(finalrank_pop3 = rank(-Population3$SP.DYN.LE00.IN))
 Population3$finalrank_pop3<- as.numeric(as.factor(Population3$finalrank_pop3))
 

 # Total score: Best aggregrate score ranked 1 
Popjoin <- left_join(Population1, Population2, "CountryName")
population_score <- left_join(Popjoin, Population3, "CountryName")
population_score <- select(population_score,"CountryName", "finalrank_pop1", "finalrank_pop2", "finalrank_pop3")

population_score <- population_score[rowSums(is.na(Population)) < 2, ]
i <- which(is.na(population_score), arr.ind = TRUE)
population_score[i] <- rowMeans(population_score[,-1], na.rm = TRUE)[i[,1]]
 
population_score <- population_score %>% mutate(score_pop = ((finalrank_pop1 + finalrank_pop2 + finalrank_pop3)/3))

population_score <- population_score %>% mutate(finalrank_pop = rank(score_pop))
```

Sense of Security Composite score:

```{r}

security <- WDI4 %>% filter(IndicatorCode == "VC.IHR.PSRC.P5"|IndicatorCode == "IC.LGL.CRED.XQ") %>% spread(IndicatorCode, Value)

#Strength of legal system - rank generates best legal strength at 1
legal <- select(security, "CountryName", "Year", "IC.LGL.CRED.XQ")
#crime[crime == 0] <- NA
legal <- legal[order(-legal$Year),]
legal <- na.omit(legal)
legal <- legal %>% distinct(CountryName, .keep_all = TRUE)
legal <- mutate(legal, rank.legal = as.numeric(as.factor(rank(-(IC.LGL.CRED.XQ)))))

#Intentional Homicide rate (per 100,000) - Rank generates least homicide rate at 1
homicide <- select(security, "CountryName", "Year", "VC.IHR.PSRC.P5")
homicide[homicide == 0] <- NA
homicide <- homicide[order(-homicide$Year),]
homicide<- na.omit(homicide)
homicide <- homicide%>% distinct(CountryName, .keep_all = TRUE)
homicide <- mutate(homicide, rank.homi = as.numeric(as.factor(rank(VC.IHR.PSRC.P5))))

#Lower country.scores have higher security 
security_score <- left_join(legal, homicide, by = "CountryName")

security_score <- select(security_score, "CountryName", "IC.LGL.CRED.XQ", "rank.legal", "VC.IHR.PSRC.P5", "rank.homi")

security_score <- mutate(security_score, finalscore_security = as.numeric(as.factor(rank(((rank.legal+rank.homi)/2)))))
```

Tourism score:

```{r}
# Selecting indicator: number of international departures (% of total population)
tourism <- WDI4 %>% filter(IndicatorCode == "ST.INT.DPRT") %>% spread(IndicatorCode, Value)
write.csv(Tourism, file = "Tourism.csv")

tourism <- select(tourism, "CountryName", "Year", "ST.INT.DPRT")
tourism <- tourism[order(-tourism$Year),]
tourism <- tourism %>% distinct(CountryName, .keep_all = TRUE)
View(tourism)

Population <- filter(Population, pop$Year == "2013")
Population <- select(Population, "CountryName", "SP.POP.TOTL")
tour <- left_join(tourism, Population, by = "CountryName")

# Highest score will get a rank of 1 
tourism_score <- tour %>% mutate(finalrank_tourism = rank(-(tour$ST.INT.DPRT/tour$SP.POP.TOTL)))
```

Ethnic Diversity: Ethniz Fractionalization is commonly used in Economics literature to compare the levels of ethnic, cultural, linguistic and religious fractionalization in different countries ([Wikipedia](https://en.wikipedia.org/wiki/List_of_countries_ranked_by_ethnic_and_cultural_diversity_level)). We use this as a measure of ethnic diversity in a country. Inclusion of this measure is one of the key strengths of our  project, since this was not included in earlier World Happiness Indices, but has been shown to be associated with health and [well-being](http://ftp.iza.org/dp9726.pdf). At a time when more [future research](http://www.nuffieldfoundation.org/impact-ethnic-diversity-well-being-and-health) is also being undertaken in this domain, we find it particularly relevant to include this in our index.

```{r}
url <- "https://en.wikipedia.org/wiki/List_of_countries_ranked_by_ethnic_and_cultural_diversity_level"
pop <- read_csv("../WDI data split/Population.csv")
h <- read_html(url)
efindex <- h %>% html_nodes("table") %>% html_table(fill = TRUE) %>%
        .[[3]]

diversity <- select(efindex, "Country", "Ethnic Diversity Rank")
colnames(diversity)[1] <- "CountryName"
colnames(diversity)[2] <- "finalrank_diversity"
```

# Extracting Data from the World Happiness Report Dataset

UN SDSN World Happiness Report Data is available for the years 2015, 2016 and 2017:

```{r}
# Load datasets
url1 <- "https://github.com/Seranne/IntroDSproject/blob/master/Source%20Data/World%20Happiness%20Report/2015.csv"
url2 <- "https://github.com/Seranne/IntroDSproject/blob/master/Source%20Data/World%20Happiness%20Report/2016.csv"
url3 <- "https://github.com/Seranne/IntroDSproject/blob/master/Source%20Data/World%20Happiness%20Report/2017.csv"

gh2015 <- read.csv(url1)
gh2016 <- read.csv(url2)
gh2017 <- read.csv(url3)

# Selecting required indicators
GHI2015 <- select(gh2015, "Country", "Region", "Family", "Freedom", "Trust (Government Corruption)", "Generosity", "Dystopia Residual")
GH2016 <- select(gh2016, "Country", "Region", "Family", "Freedom", "Trust (Government Corruption)", "Generosity", "Dystopia Residual")
GH2017 <- select(gh2017, "Country", "Family", "Freedom", "Trust..Government.Corruption.", "Generosity", "Dystopia.Residual")

gh <- read_csv("Original Data/online-data-chapter-2-whr-2017.csv")

gh1 <- gh %>% select(country, year, `Social support`, Generosity, `Freedom to make life choices`, `Perceptions of corruption`, `Confidence in national government`, `Positive affect`, `Negative affect`) %>% filter(year == 2016)

whr <- read_csv("Original Data/gh2017.csv")

whr <- whr %>% select(Country, Dystopia.Residual) %>% mutate(country = Country)

WHR <- left_join(gh, whr, "country")  
colnames(WHR)[2] <- "CountryName"
write.csv(WHR, file = "final_whr.csv")

#Citizen report of positive feelings
pos_affect <- WHR %>% 
  group_by(CountryName) %>% 
  summarise(mean_pa = mean(`Positive affect`)) %>%
  na.omit() %>%
  mutate(finalrank_pos = rank(mean_pa))

write.csv(pos_affect, file = "Positive Affect.csv")

#Citizen report of negative feelings
neg_affect <- WHR %>% 
  group_by(CountryName) %>% 
  summarise(mean_na = mean(`Negative affect`)) %>%
  na.omit() %>%
  mutate(finalrank_neg = rank(mean_na))
View(neg_affect)
write.csv(neg_affect, file = "Negative Affect.csv")

#Dystopia score

dystopia <- WHR %>% 
  group_by(CountryName) %>% 
  summarise(mean_dys = mean(Dystopia.Residual)) %>%
  na.omit() %>%
  mutate(finalrank_dys = rank(mean_dys))
View(dystopia)
write.csv(dystopia, file = "Dystopia_score.csv")


```

# Extracting Data from the Happy Planet Index

2016 Happy Planet Index data is available through [this link](http://happyplanetindex.org/countries). A cleaned .CSV is available through the code below this one, on which further analysis was run.

```{r, EVAL=FALSE}
# Load dataset
hpi_data_2016 <- readxl::read_xlsx("Your/File/Path/Here.xlsx")

# Select indicators of interest 
HPI2016 <- select(hpi_data_2016, "Country", "Region", "Average_Wellbeing_(0-10)", "Happy_Life_Years", "Footprint_(gha/capita)", "Inequality_of_Outcomes", "Inequality-adjusted_Life_Expectancy", "Inequality-adjusted_Wellbeing")

```{r}
hpi_data_2016 <- read_csv("../Original Data/hpi-data-2016.csv")
colnames(hpi_data_2016)[2] <- "CountryName"
 hpi_data_20161<- select(hpi_data_2016, "CountryName", "Inequality-adjusted_Life_Expectancy")
hpi_data_20161<- na.omit(hpi_data_20161)
 hpi_data_20161 <- hpi_data_20161%>% distinct(CountryName, .keep_all = TRUE)
 hpi_data_20161 <- hpi_data_20161 %>% mutate(finalrank_hpi1 = rank(-hpi_data_20161$`Inequality-adjusted_Life_Expectancy`))
 hpi_data_20161$finalrank_hpi1<- as.numeric(as.factor(hpi_data_20161$finalrank_hpi1))
 
 hpi_data_20162<- select(hpi_data_2016, "CountryName",  "Inequality-adjusted_Wellbeing")
 hpi_data_20162<- na.omit(hpi_data_20162)
 hpi_data_20162 <- hpi_data_20162%>% distinct(CountryName, .keep_all = TRUE)
 hpi_data_20162 <- hpi_data_20162 %>% mutate(finalrank_hpi2 = rank(-hpi_data_20162$`Inequality-adjusted_Wellbeing`))
 hpi_data_20162$finalrank_hpi2<- as.numeric(as.factor(hpi_data_20162$finalrank_hpi2))
 
 hpi_data_20163<- select(hpi_data_2016, "CountryName",  "Happy_Planet_Index")
 hpi_data_20163<- na.omit(hpi_data_20163)
 hpi_data_20163 <- hpi_data_20163%>% distinct(CountryName, .keep_all = TRUE)
 hpi_data_20163 <- hpi_data_20163 %>% mutate(finalrank_hpi3 = rank(-hpi_data_20163$Happy_Planet_Index))
 hpi_data_20163$finalrank_hpi3<- as.numeric(as.factor(hpi_data_20163$finalrank_hpi3))
 

 
 Enjoin <- left_join(hpi_data_20161, hpi_data_20162, "CountryName")
hpi_data_2016 <- left_join(Enjoin, hpi_data_20163, "CountryName")

 hpi_data_2016<- select(hpi_data_2016,"CountryName", "finalrank_hpi1", "finalrank_hpi2", "finalrank_hpi3")
 

 
 hpi_data_2016 <- hpi_data_2016 %>% mutate(score_hpi = ((finalrank_hpi1 + finalrank_hpi2 + finalrank_hpi3)/3))
 hpi_data_2016 <- hpi_data_2016 %>% mutate(finalrank_hpi = rank(hpi_data_2016$score_hpi))
 


```

```{r}
# Load dataset
HPI2016 <- read.csv("https://raw.githubusercontent.com/Seranne/IntroDSproject/master/Cleaned_Data/cleaned_hpi_2016.csv")
```


# Checking for correlations between indicators chosen based on literature review

# Deriving new well-rounded well-being index 

#Gather all the variable indices join to create on table 

```{r}
Communication_score <- read_csv("../Scored data+Rmds/Communication_score.csv")
Education_score <- read_csv("../Scored data+Rmds/Education_score.csv")
Emissions_score <- read_csv("../Scored data+Rmds/Emissions_score.csv")
Employment_score <- read_csv("../Scored data+Rmds/Employment_score.csv")
Energy_score <- read_csv("../Scored data+Rmds/Energy_score.csv")
Environment_score <- read_csv("../Scored data+Rmds/Environment_score.csv")
FoodDeficit_score <- read_csv("../Scored data+Rmds/FoodDeficit_score.csv")
Gender_score <- read_csv("../Scored data+Rmds/Gender_score.csv")
Population_score <- read_csv("../Scored data+Rmds/Population_score.csv")
Security_score <- read_csv("../Scored data+Rmds/Security_score.csv")
Tourism_score <- read_csv("../Scored data+Rmds/Tourism_score.csv")
GDP_score <- read_csv("../Scored data+Rmds/GDP_score.csv")
childwelfare_score <- read_csv("../Scored data+Rmds/childwelfare_score.csv")
diversity_score <- read_csv("../Scored data+Rmds/diversity_score.csv")
happyplanet_score <- read_csv("../Scored data+Rmds/happyplanet_score.csv")
Negative_Affect <- read_csv("../Scored data+Rmds/Negative Affect.csv")
Positive_Affect <- read_csv("../Scored data+Rmds/Positive Affect.csv")
```


```{r}
final_score_table <- communication_score %>%
  full_join(education_score, by='CountryName') %>%
  full_join(emissions_score, by='CountryName') %>%
  full_join(environment_score, by='CountryName') %>%
  full_join(foodDeficit_score, by='CountryName') %>%
  full_join(gender_score, by='CountryName') %>%
  full_join(population_score, by='CountryName') %>%
  full_join(employment_score, by='CountryName') %>%
  full_join(energy_score, by='CountryName') %>%
  full_join(security_score, by='CountryName') %>%
  full_join(tourism_score, by='CountryName') %>%
  full_join(economy_score, by='CountryName') %>%
  full_join(childwelfare_score, by='CountryName')%>%
  full_join(diversity_score, by='CountryName')%>%
  full_join(happyplanet_score, by='CountryName')%>%
  full_join(Negative_Affect, by='CountryName')%>%
  full_join(Positive_Affect, by='CountryName')
```

# This contains the columns with only the required final ranks for each variable
```{r}
final_score <- final_score_table %>% select(CountryName,
                                            CountryCode, 
                                            finalscore_child,
                                            finalrank_comm,
                                            finalrank_diversity,
                                            finalrank_edu,
                                            finalrank_emission,
                                            finalrank_empl,
                                            finalrank_eng,
                                            finalrank_env,
                                            finalrank_deficit,
                                            finalrank_gen,
                                            finalrank_GDP,
                                            finalrank_pop,
                                            finalscore_security,
                                            finalrank_tourism,
                                            finalrank_hpi,
                                            finalrank_neg,
                                            finalrank_pos)
```


#fill in regional data

```{r}
url <- "https://raw.githubusercontent.com/lukes/ISO-3166-Countries-with-Regional-Codes/master/all/all.csv"

regions <-read.csv(url)
regions <- regions %>% select(name, region, sub.region)
colnames(regions)[1] <- "CountryName"
final_score <- left_join(final_score, regions, "CountryName")
```

#drop countries with too many NA's and use of mean of the coutries other ranking to fill in NA'for remaining countries

```{r}
final_score <- final_score[rowSums(is.na(final_score)) < 6, ]
i <- which(is.na(final_score), arr.ind = TRUE)
final_score[i] <- rowMeans(final_score[,3:19], na.rm = TRUE)[i[,1]]
 
final_score<- final_score %>% 
   mutate(ourindex = (finalscore_child + 
                        finalrank_comm + 
                        finalrank_diversity + 
                        finalrank_edu + 
                        finalrank_emission + 
                        finalrank_empl + 
                        finalrank_eng + 
                        finalrank_env + 
                        finalrank_deficit + 
                        finalrank_gen + 
                        finalrank_GDP + 
                        finalrank_pop + 
                        finalscore_security + 
                        finalrank_tourism + 
                        finalrank_hpi + 
                        finalrank_neg + 
                        finalrank_pos)/17) %>% 
  mutate(finalindex = rank(ourindex))
 
 write.csv(final_score, file = "CalculatedOurindex.csv")
```


## Final Analysis: What did you learn about the data? How did you answer the questions? How can you justify your answers?
